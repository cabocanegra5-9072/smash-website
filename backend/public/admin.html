<!DOCTYPE html>
<html>
<head>
  <title>Admin Import</title>
  <link rel="stylesheet" href="style.css">
  <meta charset="utf-8" />
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="leaderboard.html">Leaderboard</a> |
    <a href="players.html">Players</a> |
    <a href="admin.html">Admin</a>
  </nav>

  <h1>Import from start.gg</h1>

  <!-- Admin key -->
  <div style="margin-top:12px;">
    <p>Admin Key:</p>
    <input id="adminKey" style="width:420px; padding:8px;" placeholder="(from your .env)" />
    <button id="btnSaveKey">Save Key</button>
    <div class="small" style="color:#666; font-size:12px; margin-top:6px;">
      Saved locally in your browser (localStorage) so you don’t retype it.
    </div>
  </div>

  <hr style="margin:16px 0;" />

<div style="margin-top:12px;">
  <h3>Option C: Auto-fill tournaments for a year</h3>

  <div style="margin-top:12px;">
  <label>Year:</label>
  <input id="autoYear" style="width:120px; padding:8px;" value="2025" />

  <label style="margin-left:12px;">Min Attendees:</label>
  <input id="minAttendees" style="width:120px; padding:8px;" value="0" />

  <label style="margin-left:12px;">Past only:</label>
  <select id="pastOnly" style="width:140px; padding:8px;">
    <option value="true">true</option>
    <option value="false" selected>false</option>
  </select>

  <button id="btnAutoFill" type="button" style="margin-left:12px;">Auto-Fill Year</button>
  </div>
</div>

  <h2>Bulk Import (Option B)</h2>
  <p>Paste <b>tournament URLs</b> (one per line). The “events” page is fine.</p>

  <textarea id="bulkUrls" style="width:820px; height:180px; padding:10px;"
    placeholder="https://www.start.gg/tournament/14-kagaribi-14-8/events&#10;https://www.start.gg/tournament/genesis-x2/events"></textarea>

  <div style="margin-top:12px;">
    <p>Season:</p>
    <input id="season" style="width:120px; padding:8px;" value="2025" />
  </div>

  <div style="margin-top:12px;">
    <p>Tier (applied to all in bulk):</p>
    <select id="tier" style="width:180px; padding:8px;">
    <option value="SP">SP (Superpremier)</option>
    <option value="P+">P+ (Premier+)</option>
    <option value="P">P (Premier)</option>
    <option value="S+">S+ (Supermajor+)</option>
    <option value="S">S (Supermajor)</option>
    <option value="A+">A+ (Major+)</option>
    <option value="A">A (Major)</option>
    <option value="B+">B+ (National/Submajor)</option>
    <option value="B" selected>B (Superregional)</option>
    <option value="C">C (Regional)</option>
    <option value="D">D (Notable Qual)</option>
    </select>
    <span style="color:#666; font-size:12px; margin-left:8px;">
      (You can tweak tiers later in tournaments.json if you want.)
    </span>
  </div>

  <div style="margin-top:12px;">
    <button id="btnLoadAll">Load Events for All URLs</button>
    <button id="btnImportAll">Import All (Ultimate Singles)</button>
    <button id="btnStop">Stop</button>
  </div>

  <div id="status" style="margin-top:10px;"></div>

  <table id="bulkTable" style="margin-top:12px; border-collapse:collapse; width:100%; display:none;">
    <thead>
      <tr>
        <th style="border:1px solid #ccc; padding:6px; text-align:left;">Tournament</th>
        <th style="border:1px solid #ccc; padding:6px; text-align:left;">URL</th>
        <th style="border:1px solid #ccc; padding:6px; text-align:left;">Selected Event</th>
        <th style="border:1px solid #ccc; padding:6px; text-align:left;">Status</th>
      </tr>
    </thead>
    <tbody id="bulkBody"></tbody>
  </table>

  <hr style="margin:20px 0;" />

  <h2>Single Import (your original)</h2>

  <div>
    <p>Paste tournament link (events page is fine):</p>
    <input id="url" style="width:640px; padding:8px;"
      value="https://www.start.gg/tournament/14-kagaribi-14-8/events" />
    <button id="btnLoad">Load Events</button>
  </div>

  <div style="margin-top:12px;">
    <p>Pick event:</p>
    <select id="eventSelect" style="width:640px; padding:8px;"></select>
  </div>

  <div style="margin-top:12px;">
    <button id="btnImport">Import Selected Event</button>
  </div>

<script>
const statusEl = document.getElementById("status");
const eventSelect = document.getElementById("eventSelect");

let stopRequested = false;
let bulkRows = []; // [{ url, tournamentName, tournamentSlug, events, selectedEventSlug, status }]

function getAdminKey() {
  return (document.getElementById("adminKey").value || "").trim();
}

function setStatus(msg) {
  statusEl.textContent = msg;
}

// Prefer an event like "Ultimate Singles"
function pickUltimateSinglesEvent(events) {
  if (!Array.isArray(events)) return null;

  const score = (name) => {
    const n = String(name || "").toLowerCase();
    let s = 0;
    if (n.includes("ultimate")) s += 10;
    if (n.includes("singles")) s += 8;
    if (n.includes("1v1") || n.includes("1 v 1")) s += 4;
    if (n.includes("doubles")) s -= 20;
    if (n.includes("squad") || n.includes("crew")) s -= 10;
    if (n.includes("amiibo")) s -= 10;
    return s;
  };

  let best = null;
  let bestScore = -9999;
  for (const e of events) {
    const sc = score(e.name);
    if (sc > bestScore) {
      bestScore = sc;
      best = e;
    }
  }

  // If everything scores terribly, still return the first event (better than null)
  return best || events[0] || null;
}

function parseBulkUrls(text) {
  return text
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(Boolean);
}

function renderBulkTable() {
  const tbl = document.getElementById("bulkTable");
  const body = document.getElementById("bulkBody");
  body.innerHTML = "";

  if (bulkRows.length === 0) {
    tbl.style.display = "none";
    return;
  }

  tbl.style.display = "";
  for (const row of bulkRows) {
    const tr = document.createElement("tr");

    const tname = row.tournamentName || row.tournamentSlug || "(unknown)";
    const selected = row.selectedEventSlug
      ? `${row.selectedEventName || ""} — ${row.selectedEventSlug}`
      : "(none)";

    tr.innerHTML = `
      <td style="border:1px solid #ccc; padding:6px;">${escapeHtml(tname)}</td>
      <td style="border:1px solid #ccc; padding:6px;">${escapeHtml(row.url)}</td>
      <td style="border:1px solid #ccc; padding:6px;">${escapeHtml(selected)}</td>
      <td style="border:1px solid #ccc; padding:6px;">${escapeHtml(row.status || "")}</td>
    `;
    body.appendChild(tr);
  }
}

function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

async function loadEventsForUrl(url) {
  const res = await fetch(`/api/tournament-events?url=${encodeURIComponent(url)}`);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
  return data; // { tournamentSlug, tournamentName, events:[{name,slug}] }
}

async function importEventSlug(eventSlug, season, tier, adminKey) {
  const res = await fetch("/api/import-event", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Key": adminKey
    },
    body: JSON.stringify({ eventSlug, season, tier })
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
  return data;
}

// ---- Admin Key Save/Load ----
const adminKeyInput = document.getElementById("adminKey");
const savedKey = localStorage.getItem("ADMIN_KEY");
if (savedKey) adminKeyInput.value = savedKey;

document.getElementById("btnSaveKey").onclick = () => {
  const k = getAdminKey();
  if (!k) return alert("Enter your admin key first.");
  localStorage.setItem("ADMIN_KEY", k);
  alert("Saved.");
};

// ---- Bulk buttons ----
document.getElementById("btnStop").onclick = () => {
  stopRequested = true;
  setStatus("Stop requested…");
};

document.getElementById("btnLoadAll").onclick = async () => {
  stopRequested = false;

  const urls = parseBulkUrls(document.getElementById("bulkUrls").value);
  if (urls.length === 0) return alert("Paste at least one tournament URL.");

  bulkRows = urls.map(u => ({ url: u, status: "Queued…" }));
  renderBulkTable();
  setStatus(`Loading events for ${urls.length} tournaments…`);

  for (let i = 0; i < bulkRows.length; i++) {
    if (stopRequested) break;

    const row = bulkRows[i];
    row.status = "Loading events…";
    renderBulkTable();

    try {
      const data = await loadEventsForUrl(row.url);
      row.tournamentSlug = data.tournamentSlug;
      row.tournamentName = data.tournamentName;

      const picked = pickUltimateSinglesEvent(data.events);
      row.selectedEventSlug = picked?.slug || null;
      row.selectedEventName = picked?.name || null;

      row.status = row.selectedEventSlug ? "✅ Ready" : "⚠️ No events found";
    } catch (e) {
      row.status = "❌ " + String(e.message || e);
    }

    renderBulkTable();
    setStatus(`Loaded ${i + 1}/${bulkRows.length}`);
  }

  setStatus(stopRequested ? "Stopped." : "Done loading. Review the table then click Import All.");
};

document.getElementById("btnImportAll").onclick = async () => {
  stopRequested = false;

  const adminKey = getAdminKey();
  if (!adminKey) return alert("Enter admin key.");

  const season = Number(document.getElementById("season").value.trim());
  const tier = document.getElementById("tier").value;

  if (!season) return alert("Enter a valid season.");
  if (!tier) return alert("Select tier.");

  if (bulkRows.length === 0) {
    return alert("Load events first (Load Events for All URLs).");
  }

  const ready = bulkRows.filter(r => r.selectedEventSlug);
  if (ready.length === 0) return alert("No rows have a selected event slug.");

  const ok = confirm(`Import ${ready.length} tournaments using "${tier}" tier for season ${season}?`);
  if (!ok) return;

  setStatus(`Importing ${ready.length} events…`);

  let imported = 0;
  let failed = 0;

  for (let i = 0; i < bulkRows.length; i++) {
    if (stopRequested) break;

    const row = bulkRows[i];
    if (!row.selectedEventSlug) continue;

    row.status = "Importing…";
    renderBulkTable();

    try {
      const data = await importEventSlug(row.selectedEventSlug, season, tier, adminKey);
      imported++;

      row.status =
        `✅ Imported. appended=${data.appended}, unmapped=${data.unmappedCount}`;
    } catch (e) {
      failed++;
      row.status = "❌ " + String(e.message || e);
    }

    renderBulkTable();
    setStatus(`Progress: ${imported} imported, ${failed} failed`);
  }

  setStatus(stopRequested
    ? `Stopped. Imported=${imported}, failed=${failed}`
    : `Done. Imported=${imported}, failed=${failed}`);
};

// ---- Single import (your original behavior, trimmed to match server) ----
document.getElementById("btnLoad").onclick = async () => {
  setStatus("Loading events...");
  eventSelect.innerHTML = "";

  const url = document.getElementById("url").value.trim();
  const res = await fetch(`/api/tournament-events?url=${encodeURIComponent(url)}`);
  const data = await res.json();

  if (!res.ok) {
    setStatus("Error: " + (data.error || res.status));
    return;
  }

  setStatus(`Loaded: ${data.tournamentName || data.tournamentSlug} (${data.events.length} events)`);

  for (const e of data.events) {
    const opt = document.createElement("option");
    opt.value = e.slug;
    opt.textContent = `${e.name} — ${e.slug}`;
    eventSelect.appendChild(opt);
  }
};

document.getElementById("btnImport").onclick = async () => {
  const adminKey = getAdminKey();
  if (!adminKey) return alert("Enter admin key");

  const season = Number(document.getElementById("season").value.trim());
  const tier = document.getElementById("tier").value;
  const eventSlug = eventSelect.value;

  if (!season) return alert("Enter season");
  if (!tier) return alert("Select tier");
  if (!eventSlug) return alert("Load and select an event first");

  setStatus("Importing...");

  try {
    const data = await importEventSlug(eventSlug, season, tier, adminKey);
    setStatus(`✅ Imported ${data.eventName}. appended=${data.appended}, unmapped=${data.unmappedCount}.`);
  } catch (e) {
    setStatus("Error: " + String(e.message || e));
  }
};

window.addEventListener("DOMContentLoaded", () => {
  const btnAutoFill = document.getElementById("btnAutoFill");
console.log("btnAutoFill found:", btnAutoFill);

if (btnAutoFill) {
  btnAutoFill.onclick = async () => {
    try {
      const adminKey = (document.getElementById("adminKey").value || "").trim();
      const year = Number((document.getElementById("autoYear").value || "").trim());
      const minAttendees = Number((document.getElementById("minAttendees").value || "").trim()) || 0;
      const past = document.getElementById("pastOnly").value;

      if (!adminKey) return alert("Enter admin key first.");
      if (!year) return alert("Enter a valid year.");

      const url =
        `/api/list-ultimate-tournaments` +
      `?year=${encodeURIComponent(year)}` +
      `&past=${encodeURIComponent(past)}` +
      `&perPage=50` +
      `&maxPages=30` +
      `&adminKey=${encodeURIComponent(adminKey)}`;

      console.log("AutoFill fetch:", url);

      const res = await fetch(url);
      const data = await res.json();

      console.log("AutoFill response:", res.status, data);

      if (!res.ok) {
        alert("Auto-fill error: " + (data.error || res.status));
        return;
      }

      const textarea = document.getElementById("bulkUrls");
      textarea.value = (data.urls || []).join("\n");

      alert(`✅ Auto-filled ${data.returned} tournaments`);
    } catch (e) {
      console.error(e);
      alert("Auto-fill crashed: " + (e.message || e));
    }
  };
}
});

</script>
</body>
</html>